     1                                  %include 'in_out.asm'
     1                              <1> ; ===============================================
     2                              <1> ; Библиотека in_out.asm (основные функции)
     3                              <1> ; ===============================================
     4                              <1> 
     5                              <1> ; --- Подпрограмма вычисления длины строки ---
     6                              <1> ; Вход:  EAX = адрес строки
     7                              <1> ; Выход: EAX = длина строки
     8                              <1> slen:
     9 00000000 53                  <1>     push ebx
    10 00000001 89C3                <1>     mov ebx, eax
    11                              <1>     
    12                              <1> .nextchar:
    13 00000003 803800              <1>     cmp byte [eax], 0
    14 00000006 7403                <1>     jz .finished
    15 00000008 40                  <1>     inc eax
    16 00000009 EBF8                <1>     jmp .nextchar
    17                              <1>     
    18                              <1> .finished:
    19 0000000B 29D8                <1>     sub eax, ebx
    20 0000000D 5B                  <1>     pop ebx
    21 0000000E C3                  <1>     ret
    22                              <1> 
    23                              <1> ; --- Подпрограмма печати строки ---
    24                              <1> ; Вход:  EAX = адрес строки
    25                              <1> sprint:
    26 0000000F 52                  <1>     push edx
    27 00000010 51                  <1>     push ecx
    28 00000011 53                  <1>     push ebx
    29 00000012 50                  <1>     push eax
    30                              <1>     
    31 00000013 E8E8FFFFFF          <1>     call slen          ; получаем длину строки
    32                              <1>     
    33 00000018 89C2                <1>     mov edx, eax       ; длина
    34 0000001A 59                  <1>     pop ecx            ; адрес строки
    35 0000001B BB01000000          <1>     mov ebx, 1         ; stdout
    36 00000020 B804000000          <1>     mov eax, 4         ; sys_write
    37 00000025 CD80                <1>     int 0x80
    38                              <1>     
    39 00000027 5B                  <1>     pop ebx
    40 00000028 59                  <1>     pop ecx
    41 00000029 5A                  <1>     pop edx
    42 0000002A C3                  <1>     ret
    43                              <1> 
    44                              <1> ; --- Подпрограмма печати строки с переводом строки ---
    45                              <1> ; Вход:  EAX = адрес строки
    46                              <1> sprintLF:
    47 0000002B E8DFFFFFFF          <1>     call sprint
    48                              <1>     
    49 00000030 50                  <1>     push eax
    50 00000031 B80A000000          <1>     mov eax, 0Ah       ; символ новой строки
    51 00000036 50                  <1>     push eax
    52 00000037 89E0                <1>     mov eax, esp
    53 00000039 E8D1FFFFFF          <1>     call sprint
    54 0000003E 58                  <1>     pop eax
    55 0000003F 58                  <1>     pop eax
    56 00000040 C3                  <1>     ret
    57                              <1> 
    58                              <1> ; --- Подпрограмма чтения строки ---
    59                              <1> ; Вход:  ECX = адрес буфера, EDX = длина буфера
    60                              <1> ; Выход: EAX = количество прочитанных байт
    61                              <1> sread:
    62 00000041 53                  <1>     push ebx
    63                              <1>     
    64 00000042 BB00000000          <1>     mov ebx, 0         ; stdin
    65 00000047 B803000000          <1>     mov eax, 3         ; sys_read
    66 0000004C CD80                <1>     int 0x80
    67                              <1>     
    68                              <1>     ; Убираем символ новой строки
    69 0000004E 83F800              <1>     cmp eax, 0
    70 00000051 7E05                <1>     jle .done
    71 00000053 48                  <1>     dec eax
    72 00000054 C6040100            <1>     mov byte [ecx+eax], 0
    73                              <1>     
    74                              <1> .done:
    75 00000058 5B                  <1>     pop ebx
    76 00000059 C3                  <1>     ret
    77                              <1> 
    78                              <1> ; --- Подпрограмма преобразования строки в число ---
    79                              <1> ; Вход:  EAX = адрес строки
    80                              <1> ; Выход: EAX = число
    81                              <1> atoi:
    82 0000005A 53                  <1>     push ebx
    83 0000005B 51                  <1>     push ecx
    84 0000005C 52                  <1>     push edx
    85 0000005D 56                  <1>     push esi
    86                              <1>     
    87 0000005E 89C6                <1>     mov esi, eax
    88 00000060 31C0                <1>     xor eax, eax
    89 00000062 31C9                <1>     xor ecx, ecx
    90                              <1>     
    91                              <1> .convert_loop:
    92 00000064 0FB61C0E            <1>     movzx ebx, byte [esi+ecx]
    93 00000068 80FB00              <1>     cmp bl, 0
    94 0000006B 7417                <1>     je .done
    95                              <1>     
    96 0000006D 80FB30              <1>     cmp bl, '0'
    97 00000070 7C10                <1>     jl .error
    98 00000072 80FB39              <1>     cmp bl, '9'
    99 00000075 7F0B                <1>     jg .error
   100                              <1>     
   101 00000077 80EB30              <1>     sub bl, '0'
   102 0000007A 6BC00A              <1>     imul eax, 10
   103 0000007D 01D8                <1>     add eax, ebx
   104                              <1>     
   105 0000007F 41                  <1>     inc ecx
   106 00000080 EBE2                <1>     jmp .convert_loop
   107                              <1> 
   108                              <1> .error:
   109 00000082 31C0                <1>     xor eax, eax
   110                              <1> 
   111                              <1> .done:
   112 00000084 5E                  <1>     pop esi
   113 00000085 5A                  <1>     pop edx
   114 00000086 59                  <1>     pop ecx
   115 00000087 5B                  <1>     pop ebx
   116 00000088 C3                  <1>     ret
   117                              <1> 
   118                              <1> ; --- Подпрограмма печати числа ---
   119                              <1> ; Вход:  EAX = число
   120                              <1> iprint:
   121 00000089 50                  <1>     push eax
   122 0000008A 51                  <1>     push ecx
   123 0000008B 52                  <1>     push edx
   124 0000008C 56                  <1>     push esi
   125                              <1>     
   126 0000008D 31C9                <1>     xor ecx, ecx
   127                              <1>     
   128                              <1> .divide_loop:
   129 0000008F 41                  <1>     inc ecx
   130 00000090 31D2                <1>     xor edx, edx
   131 00000092 BE0A000000          <1>     mov esi, 10
   132 00000097 F7F6                <1>     div esi
   133 00000099 83C230              <1>     add edx, 48
   134 0000009C 52                  <1>     push edx
   135 0000009D 83F800              <1>     cmp eax, 0
   136 000000A0 75ED                <1>     jnz .divide_loop
   137                              <1>     
   138                              <1> .print_loop:
   139 000000A2 49                  <1>     dec ecx
   140 000000A3 89E0                <1>     mov eax, esp
   141 000000A5 E865FFFFFF          <1>     call sprint
   142 000000AA 58                  <1>     pop eax
   143 000000AB 83F900              <1>     cmp ecx, 0
   144 000000AE 75F2                <1>     jnz .print_loop
   145                              <1>     
   146 000000B0 5E                  <1>     pop esi
   147 000000B1 5A                  <1>     pop edx
   148 000000B2 59                  <1>     pop ecx
   149 000000B3 58                  <1>     pop eax
   150 000000B4 C3                  <1>     ret
   151                              <1> 
   152                              <1> ; --- Подпрограмма печати числа с переводом строки ---
   153                              <1> ; Вход:  EAX = число
   154                              <1> iprintLF:
   155 000000B5 E8CFFFFFFF          <1>     call iprint
   156                              <1>     
   157 000000BA 50                  <1>     push eax
   158 000000BB B80A000000          <1>     mov eax, 0Ah
   159 000000C0 50                  <1>     push eax
   160 000000C1 89E0                <1>     mov eax, esp
   161 000000C3 E847FFFFFF          <1>     call sprint
   162 000000C8 58                  <1>     pop eax
   163 000000C9 58                  <1>     pop eax
   164 000000CA C3                  <1>     ret
   165                              <1> 
   166                              <1> ; --- Подпрограмма завершения программы ---
   167                              <1> quit:
   168 000000CB BB00000000          <1>     mov ebx, 0
   169 000000D0 B801000000          <1>     mov eax, 1
   170 000000D5 CD80                <1>     int 0x80
   171 000000D7 C3                  <1>     ret
     2                                  
     3                                  SECTION .data
     4 00000000 6E616D652E74787400      filename db 'name.txt', 0
     5 00000009 D09AD0B0D0BA20D092-     pr db 'Как Вас зовут? ', 0
     5 00000012 D0B0D18120D0B7D0BE-
     5 0000001B D0B2D183D1823F2000 
     6 00000024 D09CD0B5D0BDD18F20-     intr db 'Меня зовут ', 0
     6 0000002D D0B7D0BED0B2D183D1-
     6 00000036 822000             
     7                                  
     8                                  SECTION .bss
     9 00000000 <res FFh>               name resb 255
    10                                  
    11                                  SECTION .text
    12                                  global _start
    13                                  
    14                                  _start:
    15                                      ; 1. Вывод приветствия
    16 000000D8 B8[09000000]                mov eax, pr
    17 000000DD E82DFFFFFF                  call sprint
    18                                      
    19                                      ; 2. Чтение имени
    20 000000E2 B9[00000000]                mov ecx, name
    21 000000E7 BAFF000000                  mov edx, 255
    22 000000EC E850FFFFFF                  call sread
    23                                      
    24                                      ; 3. Создание/открытие файла
    25                                      ; sys_creat: eax=8, ebx=имя файла, ecx=права доступа
    26 000000F1 B808000000                  mov eax, 8          ; sys_creat (создание файла)
    27 000000F6 BB[00000000]                mov ebx, filename   ; имя файла
    28 000000FB B9A4010000                  mov ecx, 644o       ; права доступа: rw-r--r-- (в восьмеричной системе)
    29 00000100 CD80                        int 0x80            ; системный вызов
    30                                      
    31                                      ; Проверка на ошибку
    32 00000102 83F800                      cmp eax, 0
    33 00000105 7C65                        jl error
    34                                      
    35                                      ; Сохранение дескриптора файла
    36 00000107 89C6                        mov esi, eax
    37                                      
    38                                      ; 4. Запись в файл строки "Меня зовут "
    39 00000109 B8[24000000]                mov eax, intr       ; адрес строки "Меня зовут "
    40 0000010E E8EDFEFFFF                  call slen           ; получаем длину строки
    41 00000113 89C2                        mov edx, eax        ; длина для записи
    42 00000115 B9[24000000]                mov ecx, intr       ; данные для записи
    43 0000011A 89F3                        mov ebx, esi        ; дескриптор файла
    44 0000011C B804000000                  mov eax, 4          ; sys_write
    45 00000121 CD80                        int 0x80
    46                                      
    47                                      ; 5. Запись в файл имени пользователя
    48 00000123 B8[00000000]                mov eax, name       ; адрес строки с именем
    49 00000128 E8D3FEFFFF                  call slen           ; получаем длину имени
    50 0000012D 89C2                        mov edx, eax        ; длина для записи
    51 0000012F B9[00000000]                mov ecx, name       ; данные для записи
    52 00000134 89F3                        mov ebx, esi        ; дескриптор файла
    53 00000136 B804000000                  mov eax, 4          ; sys_write
    54 0000013B CD80                        int 0x80
    55                                      
    56                                      ; 6. Добавление перевода строки в файл
    57 0000013D B80A000000                  mov eax, 0Ah        ; символ новой строки
    58 00000142 50                          push eax
    59 00000143 89E1                        mov ecx, esp        ; адрес символа в стеке
    60 00000145 BA01000000                  mov edx, 1          ; длина (1 байт)
    61 0000014A 89F3                        mov ebx, esi        ; дескриптор файла
    62 0000014C B804000000                  mov eax, 4          ; sys_write
    63 00000151 CD80                        int 0x80
    64 00000153 58                          pop eax             ; очистка стека
    65                                      
    66                                      ; 7. Закрытие файла
    67 00000154 89F3                        mov ebx, esi        ; дескриптор файла
    68 00000156 B806000000                  mov eax, 6          ; sys_close
    69 0000015B CD80                        int 0x80
    70                                      
    71                                      ; 8. Сообщение об успехе
    72 0000015D B8[39000000]                mov eax, msg_success
    73 00000162 E8C4FEFFFF                  call sprintLF
    74                                      
    75 00000167 E85FFFFFFF                  call quit
    76                                  
    77                                  error:
    78 0000016C B8[5F000000]                mov eax, msg_error
    79 00000171 E8B5FEFFFF                  call sprintLF
    80 00000176 E850FFFFFF                  call quit
    81                                  
    82                                  SECTION .data
    83 00000039 D0A4D0B0D0B9D0BB20-     msg_success db 'Файл успешно создан!', 0
    83 00000042 D183D181D0BFD0B5D1-
    83 0000004B 88D0BDD0BE20D181D0-
    83 00000054 BED0B7D0B4D0B0D0BD-
    83 0000005D 2100               
    84 0000005F D09ED188D0B8D0B1D0-     msg_error db 'Ошибка при создании файла!', 0
    84 00000068 BAD0B020D0BFD180D0-
    84 00000071 B820D181D0BED0B7D0-
    84 0000007A B4D0B0D0BDD0B8D0B8-
    84 00000083 20D184D0B0D0B9D0BB-
    84 0000008C D0B02100           
    85                                  
